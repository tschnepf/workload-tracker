## Version 2024/05/28
# smc-projects.com domain

server {
    listen 443 ssl;
    listen [::]:443 ssl;

    # Primary apex host
    server_name smc-projects.com;

    include /config/nginx/ssl.conf;
    # Nginx 1.25+: enable HTTP/2 via directive (listen ... http2 is deprecated)
    http2 on;

    client_max_body_size 0;

    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Cross-Origin-Opener-Policy "same-origin" always;
    add_header Cross-Origin-Resource-Policy "same-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=()" always;
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

    # API endpoints - Proxy to Django backend on port 8000
    # Increase upload size for backup restore route only
    location /api/backups/upload-restore/ {
        include /config/nginx/proxy.conf;
        # Using host IP + published port to avoid cross-stack DNS issues
        proxy_pass http://10.20.30.2:8000;
        client_max_body_size 2g;
    }

    # People/Projects import size overrides
    location /api/people/import_excel/ {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000;
        client_max_body_size 100m;
    }

    location /api/projects/import_excel/ {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000;
        client_max_body_size 100m;
    }

    # All other API calls
    location /api/ {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000;
    }

    # Django admin - Proxy to Django backend
    location /admin/ {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000;
    }

    # Health check endpoint
    location /health {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000/api/health/;
        access_log off;
    }

    # Serve Django collected static and media directly from SWAG (mount volumes)
    location /static/ {
        alias /var/www/static/;
        access_log off;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    location /media/ {
        alias /var/www/media/;
        access_log off;
        expires 7d;
        add_header Cache-Control "public, max-age=604800";
    }

    # Frontend application - Proxy to React frontend on port 3000
    location / {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:3000;
        # WebSocket support (proxy.conf already sets upgrade headers for SWAG)
    }

    # Rate limiting for auth endpoints
    location ~ ^/api/(token|auth)/ {
        include /config/nginx/proxy.conf;
        proxy_pass http://10.20.30.2:8000;
        # Apply rate limiting (requires rate limiting zone configured in nginx.conf)
        # limit_req zone=auth_zone burst=20 nodelay;
    }

    # Security - Block common attack patterns
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~* \.(env|log|ini|conf|bak|swp|tmp)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
}

# HTTP redirect to HTTPS
server {
    listen 80;
    listen [::]:80;

    server_name smc-projects.com www.smc-projects.com;

    # Preserve the originally requested host during redirect
    return 301 https://$host$request_uri;
}

# HTTPS redirect for www â†’ apex
server {
    listen 443 ssl;
    listen [::]:443 ssl;

    server_name www.smc-projects.com;

    include /config/nginx/ssl.conf;
    http2 on;

    return 301 https://smc-projects.com$request_uri;
}
